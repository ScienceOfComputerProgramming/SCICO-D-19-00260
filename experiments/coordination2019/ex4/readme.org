# -*- org-confirm-babel-evaluate: nil; -*-

* Choreography
The last example demonstrates problems led by the usage of the same
message in the concurrent threads.
The set   consists of a single pomset, which represents two concurrent
sub-choreography.
The usage of message *x* in both threads can cause the following problem:
1) the left thread of *a* executes *AB!l1* and *AB!x*
2) after the output *BC!r2*, the right thread
   of *b* executes the input *AB?x*, so
   "stealing" the message *x* generated by the left thread of
   *a* and meant for the left thread of *b*;
3) the right thread of *b* executes *BC!r3*.

#+begin_src python :session coordination :results output drawer replace
def create_thread_parallel_same_msg(th, msg):
    gr = nx.DiGraph()
    ac1 = add_pair(gr, "a", "c", th*4+1, "%s1" % msg)
    bc2 = add_pair(gr, "b", "c", th*4+2, "%s2" % msg)
    ab3 = add_pair(gr, "a", "b", th*4+3, "x")
    bc4 = add_pair(gr, "b", "c", th*4+4, "%s3" % msg)
    gr.add_edge(ac1[0], ab3[0])
    gr.add_edge(bc2[0], ab3[1])
    gr.add_edge(ab3[1], bc4[0])
    gr.add_edge(ac1[1], bc2[1])
    gr.add_edge(bc2[1], bc4[1])
    return gr

def gen_parallel_same_msg():
    G1 = create_thread_parallel_same_msg(1, "l")
    G2 = create_thread_parallel_same_msg(2, "r")
    G = nx.union(G1, G2)
    G = transitive_closure(G)
    return G

global_view = [gen_parallel_same_msg()]
debug_graphs(global_view, "test-coordination/4/global-view")
#+end_src

#+RESULTS:
:RESULTS:
Pomset 1
[[file:test-coordination/4/global-view/graph-0.png]]
:END:



* CC2
#+begin_src python :session coordination
cc2c = cc2closure(global_view)
cc2res = cc2test(global_view, cc2c)
cc2res
#+end_src

#+RESULTS:
| Graph | Match |
|     1 | 1     |
|     2 | error |




#+begin_src python :session coordination :results output drawer replace
errors = [cc2c[k] for k in [i-1 for [i,j] in cc2res[1:] if j == "error"]]
debug_graphs(errors, "test-coordination/3/cc2-errors")
#+end_src

#+RESULTS:
:RESULTS:
Pomset 1
[[file:test-coordination/3/cc2-errors/graph-0.png]]
:END:




* CC3
#+begin_src python :session coordination :results value
(cc3c, prefixes) = cc3closure(global_view)
(len(cc3c), len(prefixes))
#+end_src

#+RESULTS:
| 570 | 361 |



#+begin_src python :session coordination :results value
cc3res = cc3test(prefixes, cc3c)
cc3res
#+end_src

#+RESULTS:
| Graph | Match |
|     1 |     1 |
|     2 |     2 |
|     3 |   198 |
|     4 |    10 |
|     5 |   308 |
|     6 |    42 |
|     7 |   164 |
|     8 |    65 |
|     9 |   358 |
|    10 |   284 |
|    11 |   331 |
|    12 |   169 |
|    13 |   247 |
|    14 |   243 |
|    15 |     6 |
|    16 |     3 |
|    17 |    83 |
|    18 |     8 |
|    19 |     7 |
|    20 |     4 |
|    21 |   224 |
|    22 |    22 |
|    23 |    55 |
|    24 |   156 |
|    25 |   320 |
|    26 |    96 |
|    27 |   296 |
|    28 |   105 |
|    29 | error |
|    30 | error |
|    31 |   359 |
|    32 |   361 |
|    33 |   334 |
|    34 | error |
|    35 | error |
|    36 |   357 |
|    37 |   354 |
|    38 |   187 |
|    39 |   305 |
|    40 |   107 |
|    41 | error |
|    42 | error |
|    43 |   295 |
|    44 |   324 |
|    45 |   121 |
|    46 | error |
|    47 | error |
|    48 |   289 |
|    49 |   165 |
|    50 |   111 |
|    51 | error |
|    52 | error |
|    53 |   137 |
|    54 |   176 |
|    55 |   127 |
|    56 |   233 |
|    57 |   303 |
|    58 |   255 |
|    59 |    79 |
|    60 |    21 |
|    61 |    14 |
|    62 |    12 |
|    63 |   191 |
|    64 |    69 |
|    65 |    43 |
|    66 |    20 |
|    67 |   200 |
|    68 |   339 |
|    69 |    86 |
|    70 |   182 |
|    71 |    49 |
|    72 |    76 |
|    73 |    40 |
|    74 |   223 |
|    75 |   298 |
|    76 |    80 |
|    77 |   265 |
|    78 |   346 |
|    79 |   117 |
|    80 |    97 |
|    81 |   159 |
|    82 |   215 |
|    83 |   133 |
|    84 |   349 |
|    85 |   158 |
|    86 |    28 |
|    87 |    15 |
|    88 |    72 |
|    89 |    91 |
|    90 | error |
|    91 | error |
|    92 | error |
|    93 |   237 |
|    94 |   253 |
|    95 | error |
|    96 |    75 |
|    97 |     5 |
|    98 |     9 |
|    99 |   307 |
|   100 |   316 |
|   101 |    44 |
|   102 | error |
|   103 | error |
|   104 | error |
|   105 |    11 |
|   106 |    16 |
|   107 | error |
|   108 |    82 |
|   109 |   203 |
|   110 |    88 |
|   111 |   227 |
|   112 | error |
|   113 | error |
|   114 |    32 |
|   115 |    85 |
|   116 |   344 |
|   117 |   160 |
|   118 |    90 |
|   119 |    46 |
|   120 |    17 |
|   121 |   222 |
|   122 | error |
|   123 | error |
|   124 |   179 |
|   125 |   263 |
|   126 |   282 |
|   127 | error |
|   128 | error |
|   129 |   327 |
|   130 |   112 |
|   131 |    58 |
|   132 |    18 |
|   133 |   348 |
|   134 | error |
|   135 | error |
|   136 |    62 |
|   137 |   210 |
|   138 |   131 |
|   139 | error |
|   140 | error |
|   141 |   146 |
|   142 |   128 |
|   143 |   202 |
|   144 |   184 |
|   145 |   148 |
|   146 | error |
|   147 | error |
|   148 |   353 |
|   149 |   242 |
|   150 |   150 |
|   151 | error |
|   152 | error |
|   153 |   172 |
|   154 |   186 |
|   155 |   197 |
|   156 |   337 |
|   157 |   254 |
|   158 | error |
|   159 | error |
|   160 |   240 |
|   161 |   261 |
|   162 |   268 |
|   163 | error |
|   164 | error |
|   165 |   274 |
|   166 |    37 |
|   167 |   205 |
|   168 | error |
|   169 | error |
|   170 |   311 |
|   171 |   313 |
|   172 |   142 |
|   173 |   149 |
|   174 |   321 |
|   175 |   225 |
|   176 |   264 |
|   177 |   258 |
|   178 | error |
|   179 | error |
|   180 |   275 |
|   181 |   266 |
|   182 | error |
|   183 | error |
|   184 |   238 |
|   185 |   277 |
|   186 |   183 |
|   187 |   103 |
|   188 | error |
|   189 | error |
|   190 |   130 |
|   191 |   151 |
|   192 |   120 |
|   193 |   323 |
|   194 | error |
|   195 | error |
|   196 |   244 |
|   197 |   280 |
|   198 | error |
|   199 | error |
|   200 |   332 |
|   201 |   271 |
|   202 | error |
|   203 | error |
|   204 |   145 |
|   205 | error |
|   206 | error |
|   207 |   144 |
|   208 |   147 |
|   209 |   195 |
|   210 | error |
|   211 | error |
|   212 | error |
|   213 |   110 |
|   214 |    29 |
|   215 |    41 |
|   216 |    19 |
|   217 |    66 |
|   218 |   213 |
|   219 | error |
|   220 | error |
|   221 | error |
|   222 |   178 |
|   223 |   245 |
|   224 | error |
|   225 |   124 |
|   226 |   343 |
|   227 |   214 |
|   228 |    67 |
|   229 |   101 |
|   230 |   196 |
|   231 | error |
|   232 | error |
|   233 | error |
|   234 |   279 |
|   235 |   340 |
|   236 | error |
|   237 |   193 |
|   238 |   239 |
|   239 |   221 |
|   240 |   106 |
|   241 |    47 |
|   242 |   208 |
|   243 | error |
|   244 | error |
|   245 | error |
|   246 |    39 |
|   247 |    63 |
|   248 | error |
|   249 |    93 |
|   250 |   290 |
|   251 |   302 |
|   252 |    77 |
|   253 |   304 |
|   254 |   170 |
|   255 | error |
|   256 | error |
|   257 | error |
|   258 |    13 |
|   259 |    25 |
|   260 | error |
|   261 |    99 |
|   262 |    94 |
|   263 |   102 |
|   264 |   123 |
|   265 | error |
|   266 | error |
|   267 | error |
|   268 | error |
|   269 | error |
|   270 | error |
|   271 |   351 |
|   272 |   257 |
|   273 |    56 |
|   274 |   201 |
|   275 | error |
|   276 | error |
|   277 |   329 |
|   278 |   180 |
|   279 | error |
|   280 | error |
|   281 |    98 |
|   282 |    95 |
|   283 |   292 |
|   284 |   135 |
|   285 | error |
|   286 | error |
|   287 | error |
|   288 | error |
|   289 |   267 |
|   290 |   252 |
|   291 |   119 |
|   292 |   235 |
|   293 |    24 |
|   294 |   293 |
|   295 | error |
|   296 | error |
|   297 |    23 |
|   298 |   297 |
|   299 |   229 |
|   300 |   231 |
|   301 |   154 |
|   302 | error |
|   303 | error |
|   304 | error |
|   305 |   209 |
|   306 |   276 |
|   307 |   270 |
|   308 |   287 |
|   309 |    31 |
|   310 |    27 |
|   311 |    26 |
|   312 |   162 |
|   313 | error |
|   314 |   157 |
|   315 | error |
|   316 |   259 |
|   317 | error |
|   318 |   260 |
|   319 | error |
|   320 |   249 |
|   321 | error |
|   322 | error |
|   323 |    34 |
|   324 | error |
|   325 |   300 |
|   326 | error |
|   327 |   326 |
|   328 |   350 |
|   329 | error |
|   330 |   173 |
|   331 | error |
|   332 |   294 |
|   333 | error |
|   334 | error |
|   335 |   360 |
|   336 |   174 |
|   337 |    45 |
|   338 |   177 |
|   339 |    30 |
|   340 |   181 |
|   341 | error |
|   342 |   285 |
|   343 | error |
|   344 |   251 |
|   345 | error |
|   346 |   175 |
|   347 | error |
|   348 |   216 |
|   349 | error |
|   350 | error |
|   351 |    35 |
|   352 | error |
|   353 |    38 |
|   354 | error |
|   355 |    50 |
|   356 |    57 |
|   357 | error |
|   358 |    59 |
|   359 | error |
|   360 |    74 |
|   361 | error |
|   362 | error |
|   363 |   335 |
|   364 |   139 |
|   365 |   171 |
|   366 |   166 |
|   367 |    84 |
|   368 |    48 |
|   369 | error |
|   370 |   104 |
|   371 | error |
|   372 |   206 |
|   373 | error |
|   374 |   114 |
|   375 | error |
|   376 |   212 |
|   377 | error |
|   378 | error |
|   379 |   232 |
|   380 | error |
|   381 |   234 |
|   382 | error |
|   383 |   219 |
|   384 |    89 |
|   385 | error |
|   386 |    64 |
|   387 | error |
|   388 |   347 |
|   389 | error |
|   390 | error |
|   391 |   262 |
|   392 |   355 |
|   393 |   207 |
|   394 |   189 |
|   395 |    53 |
|   396 |   283 |
|   397 | error |
|   398 |   241 |
|   399 | error |
|   400 |   318 |
|   401 | error |
|   402 |   272 |
|   403 | error |
|   404 |   230 |
|   405 | error |
|   406 | error |
|   407 |   226 |
|   408 | error |
|   409 |   309 |
|   410 | error |
|   411 |   333 |
|   412 |   281 |
|   413 | error |
|   414 |    81 |
|   415 | error |
|   416 |   345 |
|   417 | error |
|   418 | error |
|   419 |   322 |
|   420 |    68 |
|   421 |    54 |
|   422 |   109 |
|   423 | error |
|   424 |   161 |
|   425 | error |
|   426 |   190 |
|   427 | error |
|   428 |   325 |
|   429 | error |
|   430 |   125 |
|   431 | error |
|   432 | error |
|   433 |   163 |
|   434 | error |
|   435 |    61 |
|   436 | error |
|   437 |    51 |
|   438 |   204 |
|   439 | error |
|   440 | error |
|   441 |    52 |
|   442 |   269 |
|   443 | error |
|   444 | error |
|   445 |   286 |
|   446 |   246 |
|   447 | error |
|   448 | error |
|   449 |   217 |
|   450 |   141 |
|   451 |   155 |
|   452 |    36 |
|   453 | error |
|   454 |    60 |
|   455 | error |
|   456 |   100 |
|   457 | error |
|   458 |   122 |
|   459 | error |
|   460 |   328 |
|   461 | error |
|   462 | error |
|   463 |   256 |
|   464 | error |
|   465 |   236 |
|   466 |   194 |
|   467 | error |
|   468 |    73 |
|   469 | error |
|   470 |   113 |
|   471 | error |
|   472 |   273 |
|   473 | error |
|   474 | error |
|   475 |   288 |
|   476 |   342 |
|   477 | error |
|   478 | error |
|   479 |   228 |
|   480 |   330 |
|   481 |   301 |
|   482 |    92 |
|   483 | error |
|   484 |   118 |
|   485 | error |
|   486 |   310 |
|   487 | error |
|   488 |   291 |
|   489 | error |
|   490 |   306 |
|   491 | error |
|   492 | error |
|   493 |   314 |
|   494 | error |
|   495 |   317 |
|   496 | error |
|   497 |    70 |
|   498 |   312 |
|   499 | error |
|   500 | error |
|   501 |    71 |
|   502 |   116 |
|   503 | error |
|   504 |   129 |
|   505 | error |
|   506 |   126 |
|   507 | error |
|   508 |   115 |
|   509 | error |
|   510 |   136 |
|   511 |   153 |
|   512 |    33 |
|   513 | error |
|   514 |   192 |
|   515 | error |
|   516 |   341 |
|   517 | error |
|   518 |   319 |
|   519 | error |
|   520 |    87 |
|   521 | error |
|   522 | error |
|   523 |   168 |
|   524 | error |
|   525 |   199 |
|   526 |   218 |
|   527 | error |
|   528 |    78 |
|   529 | error |
|   530 |   108 |
|   531 | error |
|   532 |   220 |
|   533 |   211 |
|   534 | error |
|   535 |   338 |
|   536 | error |
|   537 |   299 |
|   538 | error |
|   539 |   140 |
|   540 | error |
|   541 |   250 |
|   542 | error |
|   543 | error |
|   544 |   356 |
|   545 | error |
|   546 |   152 |
|   547 |   336 |
|   548 | error |
|   549 |   167 |
|   550 | error |
|   551 | error |
|   552 |   248 |
|   553 |   315 |
|   554 | error |
|   555 |   132 |
|   556 | error |
|   557 |   134 |
|   558 | error |
|   559 |   143 |
|   560 | error |
|   561 |   138 |
|   562 | error |
|   563 |   278 |
|   564 | error |
|   565 |   352 |
|   566 | error |
|   567 |   188 |
|   568 | error |
|   569 |   185 |
|   570 | error |



